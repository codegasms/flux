<%
          var folderData = [];
          var pwd = null;
          var response = null;
          async function fetchData(parentPath, currentDir) { 
            const response = await fetch(params.server_url + '/spaces/get-id', { 
              method: 'POST', 
              headers: {
                'accept': 'application/json',
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + params.cookies.accessToken, 
            },
            body: JSON.stringify({spaceParent: parentPath, fileName:currentDir}),
           })
           .then((res) => res.json()).then((data) => {
              // console.log(data);
              return data;
            });
            return response;
          }
          async function fetchData1() { 
            response = await fetch(params.server_url + '/spaces/meta', { 
              method: 'POST', 
              headers: {
                'accept': 'application/json',
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + params.cookies.accessToken, 
            },
            body: JSON.stringify({spaceParent: path, fileName:""}),
           })
            .then((res) => res.json());
            // console.log(response);
            folderData = response;
          }
          async function fetchData2() {
            response = await fetch(params.server_url + '/spaces/meta/' + path, {
              method: 'GET',
              headers: {
              'accept': 'application/json',
              'Authorization': 'Bearer ' + params.cookies.accessToken,
              },
            })
            .then((res) => res.json());
            folderData = response.slice(1);
            // console.log(response[0].spaceParent);
            if (response[0].spaceParent === "/") {
              pwd = response[0].fileName;
            }else{
              pwd = response[0].spaceParent+"/"+response[0].fileName;
            }
          }
          if(path === "/"){
            await fetchData1();
          } else {
            await fetchData2();
          } 
          %>

<div class="px-8 w-full overflow-y-scroll no-scrollbar">
  <!-- My Storage Header -->
  <div class="flex justify-between w-full my-4">
    <h1 class="text-[24px] font-['Quicksand'] font-bold">My Storage</h1>
    <button class="btn btn-ghost bg-base-100 font-bold rounded-full flex justify-center items-center " id="toggleAnalytics">
      <span class="material-symbols-outlined"> insert_chart </span>
    </button>
  </div>
  <!-- Analytics -->
  <div class="bg-base-100 rounded-[16px] p-6 scale-1 transition-all" id="analytics">
    <div class="w-full">
      <h1 class="text-[24px] font-['Quicksand'] font-bold">Overview</h1>
    </div>
    <canvas id="myChart" height="60" aria-label="Graph for storage analytics">
      <p>Your browser does not support the canvas element.</p>
    </canvas>
  </div>
  <div class="w-full rounded-[16px] mt-5 bg-base-100 mb-6 transition-all">
    <div class="px-8 py-6 w-full">
      <div class="flex items-center justify-between">
        <h1 class="text-[24px] font-['Quicksand'] font-bold">My Files</h1>
        <button class="btn btn-primary" onclick="my_modal_2.showModal()">Create Folder</button>
        <dialog id="my_modal_2" class="modal">
          <div class="modal-box">
            <h3 class="font-bold text-lg">Create Folder</h3>
            <p class="py-4">Please enter the name of the folder</p>
            <!-- <form action="http://localhost:3000/spaces/create" method="POST" enctype="multipart/form-data" onsubmit="prependPwd()"> -->
            <!-- <input type="hidden" name="variable" id="spaceParentForm" value="<%#=pwd ? pwd : "/"%>"> -->
            <input type="text" required placeholder="Folder name" class="input input-bordered w-full max-w-xs mx-3" id="folderName" name="spaceParent" />
            <button type="submit" class="btn btn-primary createFolder" id="<%=pwd ? pwd : "/"%>"> Create </button>
            <!-- </form> -->
          </div>
          <form method=" dialog" class="modal-backdrop">
            <button>close</button>
          </form>
        </dialog>
      </div>
      <!-- Breadcrumbs -->

      <div class="text-sm breadcrumbs">
        <ul>
          <li><a href="/space">Home</a></li>
          <% 
            if(path !== "/"){
              pwd = pwd.split("/");
              let prevdir = "/";
              
              for( dir of pwd) {
                let id = await fetchData(prevdir, dir);
          %>
          <li><a href="/space/<%= id._id%>"><%= dir %></a></li>
          <%
          prevdir = prevdir+dir+"/";
            }} %>
        </ul>
      </div>
      <!-- Folders -->
      <div class="flex flex-wrap mt-4 gap-x-4">


        <% 
          function formatBytes(bytes, decimals = 2) {
          if (bytes === 0) return '0 Bytes';

          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

          const i = Math.floor(Math.log(bytes) / Math.log(k));

          return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
          }
        folderData.forEach(folder => { 
            if(folder.isDir){ %>
        <button class="btn btn-ghost btn-xs sm:btn-sm md:btn-md lg:btn-lg border-2 border-base-200 flex gap-4 my-2" onclick="window.location.href='/space/<%= folder._id %>'">
          <img src="/images/space/folder_closed.png" />
          <%= folder.fileName %>
        </button>
        <% }}); %>

      </div>
      <!-- Files -->
      <div class="mt-2">
        <table class="table">
          <tr>
            <th>File Name</th>
            <th>Access</th>
            <th>Date Created</th>
            <th>Folder</th>
            <th>Size</th>
          </tr>
          <% folderData.forEach( entry => { %>
          <% if(!entry.isDir){ %>
          <tr>
            <td><a class="download" href="<%= params.server_url+"/spaces/stream/"+entry._id %>"><%= entry.fileName %></a></td>
            <td><%= entry.visibility %></td>
            <td><%= entry.created.slice(0, 10) %></td>
            <td><%= entry.spaceParent %></td>
            <td><%= formatBytes(entry.size)%> </td>
          </tr>
          <% } %>
          <% }); %>
        </table>
      </div>
    </div>
  </div>
</div>